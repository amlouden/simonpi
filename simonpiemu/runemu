#!/bin/sh

. $OPT/simonpiemu/network

# QEMU Variables
export QEMU_AUDIO_DRV=none

finalizeIt() {
	umountParts
	umountImg
	unlock
	checkNetwork
}

initChecks() {
	checkLock
	checkQemu
	checkNetwork
}

checkLock() {
	if [ ! -f /tmp/simonpi.lock ]; then
		lock
	else
		echo -e "[$R-$RST] Already in use. Please check for other instances"
	fi
}

lock() {
	touch /tmp/simonpi.lock
}

unlock() {
	rm /tmp/simonpi.lock
}

checkQemu() {
	if [ ! -z "$(pidof $QEMUARM)" ]; then
		pkill "$QEMUARM"
	fi
}

run_rpi() {
	$QEMUARM -nographic \
		-cpu arm1176 \
		-m 256 \
		-M versatilepb \
		-drive file=$SIMONPIFOLDER/sd-arch-$MODEL-qemu.img,format=raw \
		-kernel $OPT/simonpiemu/qemu-kernel-rpi \
		-append "root=/dev/sda2 rw console=ttyAMA0 loglevel=0 panic=1" \
		-no-reboot \
		-net nic,macaddr="$MACADDR" \
		-net tap,ifname="$TAP",script=no,downscript=no
}

run_rpi2() {
	$QEMUARM -nographic \
		-cpu cortex-a15 \
		-m 1024 \
		-M vexpress-a15 \
		-sd $SIMONPIFOLDER/sd-arch-$MODEL-qemu.img \
		-kernel $OPT/simonpiemu/qemu-kernel-rpi-2 \
		-append "root=/dev/mmcblk0p2 rw console=ttyAMA0 loglevel=0 panic=1" \
		-dtb $OPT/simonpiemu/vexpress-v2p-ca15-tc1.dtb \
		-no-reboot \
		-net nic,macaddr="$MACADDR" \
		-net tap,ifname="$TAP",script=no,downscript=no
}

run_rpi3() {
	$QEMUARM64 -nographic \
		-cpu cortex-a53 \
		-m 2048 \
		-M vexpress-a15 \
		-sd $SIMONPIFOLDER/sd-arch-$MODEL-qemu.img \
		-kernel $OPT/simonpiemu/qemu-kernel-rpi-3 \
		-append "root=/dev/mmcblk0p2 rw console=ttyAMA0 panic=1" \
		-dtb $OPT/simonpiemu/vexpress-v2p-ca15-tc1.dtb \
		-net nic,macaddr="$MACADDR" \
		-net tap,ifname="$TAP",script=no,downscript=no
}

run_emu() {
	case $MODEL in
		rpi    ) initChecks && run_rpi && finalizeIt ;;
		rpi-2  ) initChecks && run_rpi2 && finalizeIt ;;
		rpi-3  ) initChecks && run_rpi3 && finalizeIt ;;
	esac
}
