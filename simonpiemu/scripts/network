#!/bin/sh

# Network Variables
BRIDGE=rasp-br0
IPFORWARD=$(sysctl -n net.ipv4.ip_forward)
TAP=rasp-tap0
GATEWAY=192.168.66.1
FIRSTIP="${GATEWAY%.1}.2"
LASTIP="${GATEWAY%.1}.254"
BROADCAST="${GATEWAY%.1}.255"
NET="${GATEWAY%.1}.0"

generateMAC() {
	# Generate Random MAC ADDRESS to avoid collisions
	MACADDR=$(printf "52:54:%02x:%02x:%02x:%02x" $(( RANDOM & 0xff)) $(( RANDOM & 0xff )) $(( RANDOM & 0xff)) $(( RANDOM & 0xff )))
}

checkTap() {
	if [ -d "/sys/class/net/$TAP" ]; then
		while [ -d "/sys/class/net/$TAP" ]; do
			TAPON=1
			TAP=rasp-tap$(( ${TAP##rasp-tap} + 1 ))
		done
	else
		TAPON=0
	fi
}

checkDnsmasq() {
	DNSMASQPID=$(pgrep -f $GATEWAY)
}

killDnsmasq() {
	if [ ! -z "$DNSMASQPID" ]; then
		sudo -E kill -9 "$DNSMASQPID"
	fi
}

killNetwork() {
	echo -e "[$PASS] Shutting down present network for QEMU ..."
	checkDnsmasq
	killDnsmasq

	while [ -d "/sys/class/net/$BRIDGE" ] || [ -d "/sys/class/net/$TAP" ]; do
		sudo -E "$IP" link set "$TAP" nomaster > /dev/null 2>&1 # Enslave tap
		sudo -E "$IP" tuntap del dev "$TAP" mode tap > /dev/null  2>&1 # Remove tap
		sudo -E "$IP" link delete "$BRIDGE" type bridge > /dev/null 2>&1 # Remove bridge
		sudo -E sysctl -w net.ipv4.ip_forward="$IPFORWARD" > /dev/null
	done
}

fkillNetwork() {
	echo -e "[$PASS] Forced network shutdown for QEMU ..."
	checkDnsmasq
	killDnsmasq

	while [ -d "/sys/class/net/$BRIDGE" ] || [ ! -z "$(find /sys/class/net/ -name "rasp*")" ]; do
		for i in $(ls -d /sys/class/net/rasp-tap*); do
			sudo -E "$IP" link set "${i##*/}" nomaster > /dev/null 2>&1 # Enslave tap
			sudo -E "$IP" tuntap del dev "${i##*/}" mode tap > /dev/null  2>&1 # Remove tap
		done
		sudo -E "$IP" link delete "$BRIDGE" type bridge > /dev/null 2>&1 # Remove bridge
	done
}

createNetwork() {
	echo -e "[$PASS] Turning up a network for QEMU ..."
	if [ "$IPFORWARD" != "1" ]; then
		sudo -E sysctl -w net.ipv4.ip_forward=1 > /dev/null
	fi

	if [ $TAPON -eq 0 ]; then
		sudo -E "$IP" link add "$BRIDGE" type bridge # add bridge
		sudo -E "$IP" addr add "$GATEWAY"/24 broadcast "$BROADCAST" dev "$BRIDGE" # Set ip to bridge interface
		sudo -E "$IP" link set "$BRIDGE" up
	fi

	sudo -E "$IP" tuntap add dev "$TAP" mode tap # Add tap interface
	sudo -E "$IP" link set $TAP master "$BRIDGE" # Bind tap to bridge
	sudo -E "$IP" link set "$TAP" up promisc on

	checkDnsmasq

	if [ -z "$DNSMASQPID" ] && ! ss -ntl | grep -q :53; then
		echo -e "[$PASS] Turning up dnsmasq for guest IP assignament ..."
		sudo -E "$DNSMASQ" --listen-address="$GATEWAY" --interface="$BRIDGE" \
			--bind-interfaces --dhcp-range="$FIRSTIP","$LASTIP"
	elif [ -z "$DNSMASQPID" ] && ss -ntl | grep -q :53; then
		echo -e "[$WARN] Perhaps port 53 is busy"
		echo -e "[$WARN] Running with no dns service ( perhaps no Internet connection for guests )"
		sudo -E "$DNSMASQ" --listen-address="$GATEWAY" --interface="$BRIDGE" \
			--bind-interfaces --dhcp-range="$FIRSTIP","$LASTIP" --port=0
	else
		echo -e "[$WARN] Another instance of $DNSMASQ is running ..."
	fi

	sudo -E "$IPTABLES" -t nat -I POSTROUTING -s "$NET"/24 -j MASQUERADE # Nat configuration
	echo -e "[$PASS] Gateway address: $G$GATEWAY$RST"
}